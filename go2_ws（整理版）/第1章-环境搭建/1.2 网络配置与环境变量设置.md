# 1.2 网络配置与环境变量设置

## 学习目标
- 理解 Go2 机器狗与计算机的网络连接方式
- 掌握静态 IP 地址的配置方法
- 学会设置 ROS2 通信环境变量

---

## 一、网络连接原理

### 1.1 Go2 机器狗的网络架构
Unitree Go2 机器狗通过**有线以太网**与计算机进行通信：
- **Go2 的默认 IP**：`192.168.123.161`（或其他固定 IP）
- **计算机需要配置的 IP**：`192.168.123.99`（同一网段）
- **通信协议**：基于 DDS (Data Distribution Service)

> **为什么需要固定 IP？**
> Go2 和计算机需要在同一局域网内通信，使用固定 IP 可以确保连接稳定，避免 IP 地址变化导致通信中断。

---

## 二、配置计算机的静态 IP

### 2.1 查看当前网络接口

首先，将计算机通过网线连接到 Go2 机器狗，然后执行：

```bash
# 查看所有网络接口
ifconfig
```

> **如果提示 ifconfig 命令不存在**：
> ```bash
> sudo apt install net-tools
> ```

在输出中找到连接 Go2 的网口，通常名称类似 `enp111s0`、`eth0` 或 `eno1`。

### 2.2 检查当前 IP 地址

```bash
# 查看特定网口的 IP（将 enp111s0 替换为你的网口名称）
ip addr show enp111s0
```

**理想情况**：应该显示 IP 为 `192.168.123.99`。
**如果不是**：需要进行以下配置。

---

## 三、设置静态 IP 地址

Ubuntu 使用 NetworkManager 管理网络，我们使用 `nmcli` 命令来配置。

### 3.1 查看当前网络连接

```bash
# 列出所有网络连接
nmcli connection show
```

你会看到类似以下的输出：
```
NAME                UUID                                  TYPE      DEVICE
Wired connection 1  abc-def-123-456                       ethernet  enp111s0
```

记住连接名称（NAME），例如 `Wired connection 1`。

### 3.2 配置静态 IP

**方法一：使用命令行配置（推荐）**

```bash
# 将 "Wired connection 1" 替换为你的连接名称
sudo nmcli connection modify "Wired connection 1" \
    ipv4.addresses "192.168.123.99/24" \
    ipv4.gateway "192.168.123.1" \
    ipv4.dns "8.8.8.8,8.8.4.4" \
    ipv4.method manual
```

**参数说明**：
- `ipv4.addresses "192.168.123.99/24"`：设置 IP 地址和子网掩码
- `ipv4.gateway "192.168.123.1"`：设置网关
- `ipv4.dns "8.8.8.8,8.8.4.4"`：设置 DNS 服务器
- `ipv4.method manual`：使用手动配置（静态 IP）

### 3.3 重启网络连接

```bash
# 断开连接
sudo nmcli connection down "Wired connection 1"

# 重新连接
sudo nmcli connection up "Wired connection 1"
```

### 3.4 验证配置

```bash
# 查看网口 IP 地址（将 enp111s0 替换为你的网口）
ip addr show enp111s0
```

你应该能看到：
```
inet 192.168.123.99/24 ...
```

---

## 四、配置 ROS2 环境变量

### 4.1 理解环境变量的作用

ROS2 通过环境变量来控制：
- 使用哪个 DDS 实现（CycloneDDS）
- 使用哪个网络接口进行通信
- 加载哪些功能包

### 4.2 编辑 setup.sh 脚本

unitree_ros2 提供了一个环境配置脚本，我们需要根据自己的网口名称进行修改。

```bash
# 打开 setup.sh 文件
gedit ~/unitree_ros2/setup.sh
```

**默认内容**：
```bash
#!/bin/bash
echo "Setup unitree ros2 environment"
source /opt/ros/humble/setup.bash
source $HOME/unitree_ros2/cyclonedds_ws/install/setup.bash
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><Interfaces>
                            <NetworkInterface name="enp3s0" priority="default" multicast="default" />
                        </Interfaces></General></Domain></CycloneDDS>'
```

### 4.3 修改网口名称

**将 `enp3s0` 修改为你的网口名称**，例如如果你的网口是 `enp111s0`：

```bash
#!/bin/bash
echo "Setup unitree ros2 environment"
source /opt/ros/humble/setup.bash
source $HOME/unitree_ros2/cyclonedds_ws/install/setup.bash
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
export CYCLONEDDS_URI='<CycloneDDS><Domain><General><Interfaces>
                            <NetworkInterface name="enp111s0" priority="default" multicast="default" />
                        </Interfaces></General></Domain></CycloneDDS>'
```

保存并关闭文件。

### 4.4 加载环境变量

每次打开新终端需要连接 Go2 时，都需要执行：

```bash
# 加载 Go2 开发环境
source ~/unitree_ros2/setup.sh
```

如果执行成功，你会看到：
```
Setup unitree ros2 environment
```

---

## 五、自动加载环境变量（可选）

### 5.1 方案一：添加到 ~/.bashrc（不推荐）

如果你只使用 Go2 开发，可以将环境变量添加到 `~/.bashrc`：

```bash
# 编辑 .bashrc
gedit ~/.bashrc

# 在文件末尾添加：
source ~/unitree_ros2/setup.sh
```

**缺点**：
- 每次打开终端都会加载 Go2 环境
- 如果有多个 ROS2 项目，可能会冲突

### 5.2 方案二：使用别名（推荐）

更好的方法是创建一个别名（alias）：

```bash
# 编辑 .bashrc
gedit ~/.bashrc

# 在文件末尾添加：
alias go2_env='source ~/unitree_ros2/setup.sh'
```

保存后执行：
```bash
source ~/.bashrc
```

以后每次需要 Go2 环境时，只需执行：
```bash
go2_env
```

---

## 六、仿真环境配置（可选）

如果你没有实体 Go2 机器狗，想在本地进行仿真测试，可以使用以下配置。

### 6.1 本地回环配置

```bash
# 使用 setup_local.sh（使用 lo 网卡）
source ~/unitree_ros2/setup_local.sh
```

或

```bash
# 使用 setup_default.sh（不指定网卡）
source ~/unitree_ros2/setup_default.sh
```

这样可以在同一台计算机上运行 Go2 的仿真程序。

---

## 七、网络配置常见问题

### 问题 1：ping 不通 Go2 机器狗
**测试命令**：
```bash
ping 192.168.123.161
```

**可能原因**：
1. 网线没有正确连接
2. IP 地址配置错误
3. Go2 机器狗没有开机

**解决方法**：
1. 检查网线连接，确保指示灯亮起
2. 重新配置 IP 地址
3. 确认 Go2 已开机并启动

### 问题 2：环境变量加载失败
**现象**：执行 `source ~/unitree_ros2/setup.sh` 后报错。

**解决方法**：
1. 检查 CycloneDDS 是否编译成功
2. 确认 ROS2 Humble 已正确安装
3. 检查 setup.sh 中的路径是否正确

### 问题 3：网口名称找不到
**解决方法**：
```bash
# 列出所有网络接口
ip link show

# 或
ifconfig -a
```

找到连接 Go2 的网口名称，更新到 setup.sh 中。

---

## 八、验证网络配置

### 8.1 测试网络连通性

```bash
# Ping Go2 机器狗
ping 192.168.123.161
```

如果能收到回复（如 `64 bytes from 192.168.123.161: icmp_seq=1 ttl=64 time=0.5 ms`），说明网络连接正常。

### 8.2 测试环境变量

```bash
# 加载环境
source ~/unitree_ros2/setup.sh

# 检查 ROS2 环境
echo $ROS_DISTRO
# 应该输出：humble

# 检查 DDS 实现
echo $RMW_IMPLEMENTATION
# 应该输出：rmw_cyclonedds_cpp
```

---

## 九、小结

本节内容我们完成了：
✅ 理解了 Go2 的网络连接方式
✅ 配置了计算机的静态 IP 地址（192.168.123.99）
✅ 修改了 setup.sh 脚本中的网口名称
✅ 学会了加载 ROS2 环境变量
✅ 验证了网络连接和环境配置

**下一步**：我们将测试与 Go2 的 ROS2 通信，验证整个开发环境是否正常工作。

---

## 拓展阅读

- [NetworkManager 配置指南](https://wiki.archlinux.org/title/NetworkManager)
- [CycloneDDS 配置文档](https://github.com/eclipse-cyclonedds/cyclonedds)
- [ROS2 环境变量说明](https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Configuring-ROS2-Environment.html)
