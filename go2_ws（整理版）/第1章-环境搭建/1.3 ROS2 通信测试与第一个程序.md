# 1.3 ROS2 通信测试与第一个程序

## 学习目标
- 掌握 ROS2 Topic 的查看和测试方法
- 理解 Go2 的消息接口结构
- 编写第一个控制 Go2 的 C++ 和 Python 程序

---

## 一、ROS2 Topic 基础操作

### 1.1 什么是 Topic？

在 ROS2 中，**Topic（话题）** 是节点之间进行通信的一种方式：
- **发布者（Publisher）**：发送消息到 Topic
- **订阅者（Subscriber）**：从 Topic 接收消息
- **消息（Message）**：在 Topic 上传输的数据

> **类比理解**：
> - Topic 就像一个"频道"
> - 发布者是"电台"，向频道广播内容
> - 订阅者是"收音机"，收听频道的内容

### 1.2 查看 Topic 列表

确保 Go2 已开机并连接到计算机，然后打开终端：

```bash
# 加载 Go2 环境
source ~/unitree_ros2/setup.sh

# 列出所有 Topic
ros2 topic list
```

你会看到很多 Topic，例如：
```
/api/sport/request
/sportmodestate
/lf/sportmodestate
/lowstate
/wirelesscontroller
...
```

### 1.3 过滤特定 Topic

如果 Topic 太多，可以使用管道过滤：

```bash
# 查找包含 "request" 的 Topic
ros2 topic list | grep -i request

# 查找包含 "sport" 的 Topic
ros2 topic list | grep -i sport
```

### 1.4 查看 Topic 信息

```bash
# 查看 Topic 的消息类型
ros2 topic info /api/sport/request
```

输出示例：
```
Type: unitree_api/msg/Request
Publisher count: 0
Subscription count: 1
```

**说明**：
- `Type`：消息类型
- `Publisher count`：发布者数量
- `Subscription count`：订阅者数量

### 1.5 查看消息结构

```bash
# 查看 Request 消息的具体定义
ros2 interface show unitree_api/msg/Request
```

这会显示消息的字段和类型，帮助我们理解如何构造消息。

---

## 二、准备工作空间

### 2.1 创建工作空间

```bash
# 创建工作空间目录
mkdir -p ~/unitree_go2_ws/src
cd ~/unitree_go2_ws
```

**工作空间结构说明**：
```
unitree_go2_ws/          # 工作空间根目录
├── src/                 # 源代码目录（功能包放在这里）
├── build/               # 编译中间文件（自动生成）
├── install/             # 安装目录（自动生成）
└── log/                 # 日志目录（自动生成）
```

### 2.2 在 VS Code 中打开

```bash
# 使用 VS Code 打开工作空间
code .
```

> **如果没有安装 VS Code**：
> ```bash
> sudo snap install code --classic
> ```

### 2.3 创建功能包目录

在 `src/` 目录下创建以下文件夹：
- `base/` - 基础功能包
- `helloworld/` - 第一个示例程序（C++）
- `helloworld_py/` - 第一个示例程序（Python）
- `tutorial/` - 后续教程代码

可以手动创建，或使用命令：
```bash
cd ~/unitree_go2_ws/src
mkdir base helloworld helloworld_py tutorial
```

---

## 三、第一个 C++ 程序：让 Go2 打招呼

### 3.1 创建 C++ 功能包

```bash
# 进入 src 目录
cd ~/unitree_go2_ws/src/helloworld

# 创建功能包
ros2 pkg create helloworld \
    --build-type ament_cmake \
    --dependencies rclcpp unitree_api \
    --node-name hello
```

**参数说明**：
- `helloworld`：功能包名称
- `--build-type ament_cmake`：使用 CMake 构建（C++）
- `--dependencies rclcpp unitree_api`：依赖的包
  - `rclcpp`：ROS2 的 C++ 客户端库
  - `unitree_api`：Go2 的 API 消息定义
- `--node-name hello`：节点名称

### 3.2 配置 VS Code 的 IntelliSense

为了让 VS Code 能够正确识别 ROS2 的头文件，需要配置 IntelliSense。

在工作空间根目录创建 `.vscode/c_cpp_properties.json`：

```json
{
    "configurations": [
        {
            "name": "Linux",
            "includePath": [
                "${workspaceFolder}/**",
                "/opt/ros/humble/include/**",
                "${HOME}/unitree_ros2/cyclonedds_ws/install/unitree_api/include/**"
            ],
            "defines": [],
            "compilerPath": "/usr/bin/g++",
            "cStandard": "c17",
            "cppStandard": "c++17",
            "intelliSenseMode": "linux-gcc-x64"
        }
    ],
    "version": 4
}
```

### 3.3 编写 hello.cpp

打开 `src/helloworld/src/hello.cpp`，替换为以下代码：

```cpp
/*
功能：让 Go2 机器狗打招呼

实现流程：
1. 创建发布对象
2. 创建定时器，每秒触发一次
3. 在定时器回调函数中发布打招呼指令
*/

#include "rclcpp/rclcpp.hpp"
#include "unitree_api/msg/request.hpp"

using namespace std::chrono_literals;

class HelloWorld : public rclcpp::Node
{
public:
    HelloWorld() : Node("helloworld")
    {
        // 输出日志
        RCLCPP_INFO(this->get_logger(), "Hello World 节点已启动！");

        // 1. 创建发布对象
        // 发布到 /api/sport/request 话题，队列大小为 10
        pub_ = this->create_publisher<unitree_api::msg::Request>(
            "/api/sport/request", 10);

        // 2. 创建定时器，每 1 秒触发一次
        timer_ = this->create_wall_timer(
            1s, std::bind(&HelloWorld::on_timer, this));
    }

private:
    // 发布者对象
    rclcpp::Publisher<unitree_api::msg::Request>::SharedPtr pub_;
    // 定时器对象
    rclcpp::TimerBase::SharedPtr timer_;

    // 定时器回调函数
    void on_timer()
    {
        // 创建 Request 消息
        unitree_api::msg::Request request;

        // 设置 API ID 为 1016（打招呼动作）
        request.header.identity.api_id = 1016;

        // 发布消息
        pub_->publish(request);

        RCLCPP_INFO(this->get_logger(), "发送打招呼指令");
    }
};

int main(int argc, char ** argv)
{
    // 初始化 ROS 2
    rclcpp::init(argc, argv);

    // 创建节点并开始自旋（处理回调）
    auto node = std::make_shared<HelloWorld>();
    rclcpp::spin(node);

    // 关闭 ROS 2
    rclcpp::shutdown();
    return 0;
}
```

**代码说明**：
1. **包含头文件**：
   - `rclcpp/rclcpp.hpp`：ROS2 C++ 库
   - `unitree_api/msg/request.hpp`：Go2 的 Request 消息定义

2. **类定义**：
   - 继承自 `rclcpp::Node`，这是所有 ROS2 节点的基类

3. **构造函数**：
   - 创建发布者：发布到 `/api/sport/request` 话题
   - 创建定时器：每 1 秒触发一次 `on_timer` 函数

4. **on_timer 函数**：
   - 创建 Request 消息
   - 设置 `api_id = 1016`（打招呼动作）
   - 发布消息

### 3.4 编译和运行

```bash
# 进入工作空间根目录
cd ~/unitree_go2_ws

# 加载 ROS2 环境
source /opt/ros/humble/setup.bash

# 编译（只编译 helloworld 包）
colcon build --packages-select helloworld

# 加载工作空间环境
source install/setup.bash

# 运行节点
ros2 run helloworld hello
```

**预期效果**：
- 终端会每秒输出："发送打招呼指令"
- Go2 机器狗会每秒执行一次打招呼动作

### 3.5 停止程序

按 `Ctrl + C` 停止程序。

---

## 四、第一个 Python 程序：让 Go2 打招呼

### 4.1 创建 Python 功能包

```bash
# 进入 src 目录
cd ~/unitree_go2_ws/src

# 创建 Python 功能包
ros2 pkg create helloworld_py \
    --build-type ament_python \
    --dependencies rclpy unitree_api \
    --node-name hello
```

**参数说明**：
- `--build-type ament_python`：使用 Python 构建
- `--dependencies rclpy unitree_api`：
  - `rclpy`：ROS2 的 Python 客户端库

### 4.2 编写 hello.py

打开 `src/helloworld_py/helloworld_py/hello.py`，替换为以下代码：

```python
'''
功能：让 Go2 机器狗打招呼

实现流程：
1. 创建发布对象
2. 创建定时器，每秒触发一次
3. 在定时器回调函数中发布打招呼指令
'''

import rclpy
from rclpy.node import Node
from unitree_api.msg import Request

class HelloWorldPy(Node):
    def __init__(self):
        super().__init__('helloworld_py')

        # 输出日志
        self.get_logger().info('Hello World Python 节点已启动！')

        # 1. 创建发布对象
        self.pub = self.create_publisher(
            Request,
            "/api/sport/request",
            10
        )

        # 2. 创建定时器，每 1.0 秒触发一次
        self.timer = self.create_timer(1.0, self.on_timer)

    def on_timer(self):
        # 3. 创建 Request 消息
        request = Request()

        # 设置 API ID 为 1016（打招呼动作）
        request.header.identity.api_id = 1016

        # 发布消息
        self.pub.publish(request)

        self.get_logger().info('发送打招呼指令')

def main():
    # 初始化 ROS2
    rclpy.init()

    # 创建节点并开始自旋
    rclpy.spin(HelloWorldPy())

    # 关闭 ROS2
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

**代码说明**：
Python 版本的逻辑与 C++ 版本完全相同，只是语法不同。

### 4.3 编译和运行

```bash
# 进入工作空间根目录
cd ~/unitree_go2_ws

# 编译（只编译 helloworld_py 包）
colcon build --packages-select helloworld_py

# 加载工作空间环境
source install/setup.bash

# 运行节点
ros2 run helloworld_py hello
```

**预期效果**：与 C++ 版本相同。

---

## 五、编译常用命令

### 5.1 完全清除编译文件

如果编译出现问题，可以完全清除：

```bash
cd ~/unitree_go2_ws
rm -rf build install log
```

### 5.2 编译所有包

```bash
colcon build
```

### 5.3 编译指定包

```bash
colcon build --packages-select helloworld
```

### 5.4 加载环境

每次编译后，都需要重新加载环境：

```bash
source install/setup.bash
```

---

## 六、调试技巧

### 6.1 查看节点列表

```bash
# 查看正在运行的节点
ros2 node list
```

### 6.2 查看话题发布情况

```bash
# 查看 /api/sport/request 话题的发布频率
ros2 topic hz /api/sport/request

# 查看话题内容
ros2 topic echo /api/sport/request
```

### 6.3 日志级别控制

```bash
# 以 DEBUG 级别运行节点
ros2 run helloworld hello --ros-args --log-level debug
```

---

## 七、常见问题解决

### 问题 1：编译时找不到 unitree_api

**原因**：没有加载 unitree_ros2 的环境。

**解决**：
```bash
source ~/unitree_ros2/cyclonedds_ws/install/setup.bash
colcon build
```

### 问题 2：运行时 Go2 没有反应

**可能原因**：
1. 网络连接问题
2. Go2 没有开机
3. 环境变量没有正确设置

**解决**：
1. 检查网络：`ping 192.168.123.161`
2. 确认 Go2 已开机
3. 重新加载环境：`source ~/unitree_ros2/setup.sh`

### 问题 3：Python 节点找不到

**原因**：setup.py 没有正确配置。

**检查**：
打开 `src/helloworld_py/setup.py`，确认 `entry_points` 部分：

```python
entry_points={
    'console_scripts': [
        'hello = helloworld_py.hello:main',
    ],
},
```

---

## 八、小结

本节内容我们完成了：
✅ 掌握了 ROS2 Topic 的基本操作命令
✅ 理解了 Go2 的 Request 消息结构
✅ 创建了第一个 C++ 程序，控制 Go2 打招呼
✅ 创建了第一个 Python 程序，实现相同功能
✅ 学会了编译和运行 ROS2 程序

**下一步**：我们将深入学习 Go2 的消息接口，包括状态获取和运动控制。

---

## 拓展阅读

- [ROS2 Topic 详解](https://docs.ros.org/en/humble/Tutorials/Beginner-CLI-Tools/Understanding-ROS2-Topics/Understanding-ROS2-Topics.html)
- [rclcpp API 文档](https://docs.ros.org/en/humble/p/rclcpp/)
- [rclpy API 文档](https://docs.ros.org/en/humble/p/rclpy/)
