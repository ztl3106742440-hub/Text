# 2.1 Go2 状态信息获取

## 学习目标
- 理解 Go2 机器狗的状态反馈机制
- 掌握订阅不同频率的状态话题
- 学会解析高层状态、低层状态和遥控器状态

---

## 一、Go2 状态反馈概述

### 1.1 什么是状态反馈？

Go2 机器狗在运行过程中，会实时发布各种**状态信息**，包括：
- **高层状态（运动模式状态）**：位置、速度、姿态等
- **低层状态（电机状态）**：各个关节的角度、力矩等
- **遥控器状态**：手柄的按键和摇杆信息

这些状态通过 ROS2 的 **Topic（话题）** 发布，我们可以订阅这些话题来获取实时数据。

### 1.2 为什么需要状态反馈？

- **监控机器人状态**：了解机器人当前的位置、速度等
- **实现闭环控制**：根据当前状态调整控制指令
- **数据记录和分析**：保存运动数据用于后续分析

---

## 二、高层状态（运动模式状态）

### 2.1 话题介绍

Go2 提供了**三个不同频率**的运动状态话题：

| 话题名称 | 发布频率 | 适用场景 |
|---------|---------|---------|
| `/lf/sportmodestate` | 20 Hz | 低频监控，节省带宽 |
| `/mf/sportmodestate` | 200 Hz | 中频控制 |
| `/sportmodestate` | 500 Hz | 高频控制，精确反馈 |

> **什么是 Hz（赫兹）？**
> - 1 Hz = 每秒 1 次
> - 20 Hz = 每秒 20 次
> - 500 Hz = 每秒 500 次
>
> 频率越高，数据更新越快，但网络负担也越大。

### 2.2 查看话题频率

```bash
# 加载 Go2 环境
source ~/unitree_ros2/setup.sh

# 查看低频话题的实际频率
ros2 topic hz /lf/sportmodestate

# 查看高频话题的实际频率
ros2 topic hz /sportmodestate
```

### 2.3 查看消息类型

```bash
# 查看话题的消息类型
ros2 topic type /sportmodestate
```

输出：
```
unitree_go/msg/SportModeState
```

### 2.4 查看消息结构

```bash
# 查看 SportModeState 消息的详细定义
ros2 interface show unitree_go/msg/SportModeState
```

**主要字段说明**：

```
# 时间戳
uint32 stamp

# 错误状态
uint32 error_code

# IMU 状态（惯性测量单元）
IMUState imu_state
  - float32 quaternion[4]    # 四元数（姿态表示）
  - float32 gyroscope[3]     # 角速度 [x, y, z]
  - float32 accelerometer[3] # 加速度 [x, y, z]

# 运动模式
uint8 mode                   # 当前运动模式

# 进度
float32 progress             # 动作完成进度 (0.0 ~ 1.0)

# 步态类型
uint8 gait_type             # 步态类型（行走、小跑等）

# 足部位置（相对于身体）
float32 foot_position_body[12]  # 4个脚的位置 [x,y,z] * 4

# 足部速度（相对于身体）
float32 foot_speed_body[12]     # 4个脚的速度 [x,y,z] * 4

# 位置（世界坐标系）
float32 position[3]          # [x, y, z]

# 速度（世界坐标系）
float32 velocity[3]          # [vx, vy, vz]

# 偏航角、俯仰角、横滚角速度
float32 yaw_speed            # 偏航角速度

# 其他状态...
```

### 2.5 查看实时数据

```bash
# 查看运动状态数据（折叠数组显示）
ros2 topic echo /sportmodestate --no-arr
```

这会实时显示 Go2 的状态信息。

### 2.6 运行内置示例

Unitree 提供了示例程序来读取运动状态：

```bash
# 进入 unitree_ros2/example 目录
cd ~/unitree_ros2/example

# 运行读取运动状态的程序
./install/unitree_ros2_example/bin/read_motion_state
```

**程序功能**：
- 订阅 `/sportmodestate` 话题
- 解析并打印位置、速度、姿态等信息

---

## 三、低层状态（电机状态）

### 3.1 话题介绍

Go2 的低层状态包含 **12 个电机**（每条腿 3 个关节）的详细信息：

| 话题名称 | 发布频率 | 适用场景 |
|---------|---------|---------|
| `/lf/lowstate` | 低频 | 监控用 |
| `/lowstate` | 高频 | 精确控制用 |

> **注意**：通常情况下，我们不需要直接控制电机，而是使用高层运动控制接口。

### 3.2 查看消息类型

```bash
# 查看话题的消息类型
ros2 topic type /lowstate
```

输出：
```
unitree_go/msg/LowState
```

### 3.3 查看消息结构

```bash
# 查看 LowState 消息的详细定义
ros2 interface show unitree_go/msg/LowState
```

**主要字段说明**：

```
# IMU 状态（同高层状态）
IMUState imu_state

# 电机状态（12个电机）
MotorState[20] motor_state   # 包含12个腿部电机 + 其他电机
  每个电机包含：
  - uint8 mode               # 电机模式
  - float32 q                # 关节角度（弧度）
  - float32 dq               # 关节角速度（弧度/秒）
  - float32 ddq              # 关节角加速度
  - float32 tau_est          # 估计力矩
  - int8 temperature         # 温度

# 足端力传感器
int16[4] foot_force          # 4个脚的接触力

# 电池状态
BmsState bms_state
  - uint8 version_high
  - uint8 version_low
  - uint8 status             # 电池状态
  - uint8 soc                # 电量百分比（State of Charge）
  - int32 current            # 电流（mA）
  - uint16 cycle             # 充放电循环次数
  - int8[2] bq_ntc           # 温度传感器

# 其他状态...
```

### 3.4 查看实时数据

```bash
# 查看低层状态数据
ros2 topic echo /lowstate --no-arr
```

---

## 四、遥控器状态

### 4.1 话题介绍

如果使用手柄控制 Go2，可以通过 `/wirelesscontroller` 话题获取手柄状态。

### 4.2 查看消息类型

```bash
# 查看话题的消息类型
ros2 topic type /wirelesscontroller
```

输出：
```
unitree_go/msg/WirelessController
```

### 4.3 查看消息结构

```bash
# 查看 WirelessController 消息的详细定义
ros2 interface show unitree_go/msg/WirelessController
```

**主要字段说明**：

```
# 摇杆值（-1.0 ~ 1.0）
float32 lx                   # 左摇杆 X 轴
float32 ly                   # 左摇杆 Y 轴
float32 rx                   # 右摇杆 X 轴
float32 ry                   # 右摇杆 Y 轴

# 按键状态（布尔值）
uint16 keys                  # 按键位掩码
```

### 4.4 查看实时数据

```bash
# 查看遥控器数据
ros2 topic echo /wirelesscontroller
```

### 4.5 运行内置示例

```bash
# 进入 unitree_ros2/example 目录
cd ~/unitree_ros2/example

# 运行读取遥控器状态的程序
./install/unitree_ros2_example/bin/read_wireless_controller
```

---

## 五、实践：编写状态订阅程序

### 5.1 创建功能包

```bash
# 进入工作空间
cd ~/unitree_go2_ws/src

# 创建功能包
ros2 pkg create state_reader \
    --build-type ament_cmake \
    --dependencies rclcpp unitree_go \
    --node-name read_state
```

### 5.2 编写 C++ 代码

打开 `src/state_reader/src/read_state.cpp`：

```cpp
/*
功能：订阅 Go2 的运动状态，并打印位置和速度信息
*/

#include "rclcpp/rclcpp.hpp"
#include "unitree_go/msg/sport_mode_state.hpp"

using namespace std::placeholders;

class StateReader : public rclcpp::Node
{
public:
    StateReader() : Node("state_reader")
    {
        RCLCPP_INFO(this->get_logger(), "状态读取节点已启动");

        // 订阅运动状态话题（使用低频话题）
        sub_ = this->create_subscription<unitree_go::msg::SportModeState>(
            "/lf/sportmodestate",
            10,
            std::bind(&StateReader::state_callback, this, _1)
        );
    }

private:
    rclcpp::Subscription<unitree_go::msg::SportModeState>::SharedPtr sub_;

    void state_callback(const unitree_go::msg::SportModeState::SharedPtr msg)
    {
        // 打印位置信息
        RCLCPP_INFO(this->get_logger(),
            "位置 [x: %.2f, y: %.2f, z: %.2f]",
            msg->position[0],
            msg->position[1],
            msg->position[2]
        );

        // 打印速度信息
        RCLCPP_INFO(this->get_logger(),
            "速度 [vx: %.2f, vy: %.2f, vz: %.2f]",
            msg->velocity[0],
            msg->velocity[1],
            msg->velocity[2]
        );

        // 打印进度
        RCLCPP_INFO(this->get_logger(),
            "进度: %.1f%%\n",
            msg->progress * 100.0
        );
    }
};

int main(int argc, char ** argv)
{
    rclcpp::init(argc, argv);
    auto node = std::make_shared<StateReader>();
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

### 5.3 编译和运行

```bash
# 编译
cd ~/unitree_go2_ws
source /opt/ros/humble/setup.bash
colcon build --packages-select state_reader

# 运行
source install/setup.bash
ros2 run state_reader read_state
```

---

## 六、小结

本节内容我们学习了：
✅ Go2 的三种状态反馈：高层状态、低层状态、遥控器状态
✅ 不同频率话题的选择和使用
✅ 如何查看消息结构和实时数据
✅ 编写了第一个状态订阅程序

**关键要点**：
- 根据应用场景选择合适的话题频率
- 高层状态用于监控位置、速度、姿态
- 低层状态用于访问电机和传感器原始数据
- 遥控器状态用于获取手柄输入

**下一步**：我们将学习如何控制 Go2 机器狗，包括运动控制和电机控制。

---

## 拓展阅读

- [ROS2 订阅者详解](https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Writing-A-Simple-Cpp-Publisher-And-Subscriber.html)
- [四元数与姿态表示](https://en.wikipedia.org/wiki/Quaternion)
- [IMU（惯性测量单元）原理](https://en.wikipedia.org/wiki/Inertial_measurement_unit)
