# 2.2 Go2 运动控制接口

## 学习目标
- 理解 Go2 的控制架构（高层控制 vs 低层控制）
- 掌握运动控制 API 的使用方法
- 学会使用 rqt 工具进行可视化控制测试
- 了解常用的运动控制指令

---

## 一、Go2 控制架构概述

### 1.1 两种控制方式

Go2 机器狗提供了两种控制方式：

| 控制方式 | 话题 | 消息类型 | 适用场景 |
|---------|------|---------|---------|
| **高层运动控制** | `/api/sport/request` | `unitree_api/msg/Request` | 日常使用，执行预定义动作 |
| **低层电机控制** | `/lowcmd` | `unitree_go/msg/LowCmd` | 高级用户，直接控制电机 |

> **推荐使用高层运动控制**：
> - 更安全，不容易损坏机器人
> - 更简单，只需指定动作 ID 和参数
> - 更稳定，内置了平衡控制算法

### 1.2 请求-响应式控制

Go2 采用**请求-响应式**控制架构：
1. **发送请求**：向 `/api/sport/request` 发布 `Request` 消息
2. **执行动作**：Go2 接收请求并执行相应动作
3. **自动恢复**：动作完成后，默认恢复到**平衡站立**状态

---

## 二、运动控制消息结构

### 2.1 查看接口信息

```bash
# 加载 Go2 环境
source ~/unitree_ros2/setup.sh

# 查找 request 相关话题
ros2 topic list | grep -i request

# 查看消息类型
ros2 topic type /api/sport/request
```

输出：
```
unitree_api/msg/Request
```

### 2.2 查看消息定义

```bash
# 查看 Request 消息的详细结构
ros2 interface show unitree_api/msg/Request
```

**Request 消息结构**：

```
# 消息头
RequestHeader header
  RequestIdentity identity
    uint32 id                    # 请求 ID（可选）
    uint32 api_id                # API ID（重要！指定动作类型）
  RequestPolicy policy           # 请求策略（可选）

# 参数（JSON 格式字符串）
string parameter                 # 动作参数，如 '{"x":0.1,"y":0.0,"z":0.5}'

# 二进制数据（可选）
uint8[] binary                   # 二进制参数（通常不用）
```

**关键字段**：
- `api_id`：指定要执行的动作（最重要！）
- `parameter`：动作的参数，JSON 格式字符串

---

## 三、运动控制 API ID 详解

### 3.1 API ID 定义

在 `unitree_go` 功能包中，定义了所有可用的 API ID。以下是常用的控制指令：

### 3.2 基本控制指令（1001-1016）

| API ID | 指令名称 | 功能说明 | 参数 |
|--------|---------|---------|------|
| 1001 | DAMP | 阻尼控制（关节松弛） | 无 |
| 1002 | BALANCESTAND | 平衡站立 | 无 |
| 1003 | STOPMOVE | 停止运动 | 无 |
| 1004 | STANDUP | 站起来 | 无 |
| 1005 | STANDDOWN | 趴下 | 无 |
| 1006 | RECOVERYSTAND | 恢复站立（从倒地恢复） | 无 |
| 1007 | EULER | 姿态控制（调整俯仰、横滚、偏航） | `{"x":roll, "y":pitch, "z":yaw}` |
| 1008 | MOVE | 移动控制 | `{"x":vx, "y":vy, "z":vyaw}` |
| 1009 | SIT | 坐下 | 无 |
| 1010 | RISESIT | 从坐姿站起 | 无 |
| 1015 | SPEEDLEVEL | 调整速度级别 | `{"speed_level":0-3}` |
| 1016 | HELLO | 打招呼动作 | 无 |

**参数说明**（MOVE 指令）：
- `x`：前进速度（m/s），正值向前，负值向后
- `y`：横向速度（m/s），正值向左，负值向右
- `z`：旋转速度（rad/s），正值逆时针，负值顺时针

### 3.3 高级动作指令（1017-1032）

| API ID | 指令名称 | 功能说明 |
|--------|---------|---------|
| 1017 | STRETCH | 伸展动作 |
| 1020 | CONTENT | 内容展示 |
| 1022 | DANCE1 | 舞蹈动作 1 |
| 1023 | DANCE2 | 舞蹈动作 2 |
| 1027 | SWITCHJOYSTICK | 切换操纵杆模式 |
| 1028 | POSE | 姿态调整 |
| 1029 | SCRAPE | 刨地动作 |
| 1030 | FRONTFLIP | 前空翻 |
| 1031 | FRONTJUMP | 前跳 |
| 1032 | FRONTPOUNCE | 前扑 |

### 3.4 步态控制指令（1061-1063）

| API ID | 指令名称 | 功能说明 |
|--------|---------|---------|
| 1061 | STATICWALK | 静态行走（慢速稳定） |
| 1062 | TROTRUN | 小跑（快速） |
| 1063 | ECONOMICGAIT | 节能步态 |

---

## 四、使用 rqt 进行可视化测试

### 4.1 什么是 rqt？

`rqt` 是 ROS2 的图形化工具集，可以方便地进行调试和测试。

### 4.2 安装 rqt

```bash
# 安装 rqt 工具
sudo apt install ros-humble-rqt -y
sudo apt install ros-humble-rqt-common-plugins -y
```

### 4.3 启动 rqt Message Publisher

```bash
# 加载 Go2 环境
source ~/unitree_ros2/setup.sh

# 启动 rqt
rqt
```

在 rqt 窗口中：
1. 点击菜单：**Plugins → Topics → Message Publisher**
2. 在 Topic 下拉菜单中选择：`/api/sport/request`
3. 点击 `+` 号添加话题

### 4.4 配置消息参数

#### 示例 1：让 Go2 平衡站立

在消息编辑器中：
- 展开 `header` → `identity`
- 设置 `api_id` 为 `1002`
- 点击左侧的复选框，开始发布
- **频率**：10 Hz（可调）

#### 示例 2：让 Go2 移动

在消息编辑器中：
- 设置 `api_id` 为 `1008`
- 设置 `parameter` 为：`{"x":0.1,"y":0.0,"z":0.2}`
  - `x=0.1`：向前 0.1 m/s
  - `y=0.0`：不横向移动
  - `z=0.2`：逆时针旋转 0.2 rad/s
- 点击左侧的复选框，开始发布

**预期效果**：Go2 会边前进边旋转。

#### 示例 3：停止运动

- 设置 `api_id` 为 `1003`
- 清空 `parameter` 字段
- 点击左侧的复选框，开始发布

**预期效果**：Go2 停止运动，恢复平衡站立。

---

## 五、运动控制编程示例

### 5.1 让 Go2 往返移动

创建一个程序，让 Go2 前进和后退。

```cpp
/*
功能：让 Go2 前进 2 秒，后退 2 秒，循环往复
*/

#include "rclcpp/rclcpp.hpp"
#include "unitree_api/msg/request.hpp"
#include <nlohmann/json.hpp>

using namespace std::chrono_literals;

class MoveController : public rclcpp::Node
{
public:
    MoveController() : Node("move_controller"), forward_(true)
    {
        RCLCPP_INFO(this->get_logger(), "运动控制节点已启动");

        // 创建发布者
        pub_ = this->create_publisher<unitree_api::msg::Request>(
            "/api/sport/request", 10);

        // 创建定时器（100ms 发布一次指令）
        timer_pub_ = this->create_wall_timer(
            100ms, std::bind(&MoveController::publish_command, this));

        // 创建定时器（2秒切换一次方向）
        timer_switch_ = this->create_wall_timer(
            2s, std::bind(&MoveController::switch_direction, this));
    }

private:
    rclcpp::Publisher<unitree_api::msg::Request>::SharedPtr pub_;
    rclcpp::TimerBase::SharedPtr timer_pub_;
    rclcpp::TimerBase::SharedPtr timer_switch_;
    bool forward_;  // true=前进, false=后退

    void publish_command()
    {
        unitree_api::msg::Request request;

        // 设置 API ID 为 MOVE（1008）
        request.header.identity.api_id = 1008;

        // 设置速度参数
        nlohmann::json js;
        js["x"] = forward_ ? 0.2 : -0.2;  // 前进或后退
        js["y"] = 0.0;
        js["z"] = 0.0;
        request.parameter = js.dump();

        // 发布
        pub_->publish(request);
    }

    void switch_direction()
    {
        forward_ = !forward_;
        RCLCPP_INFO(this->get_logger(), forward_ ? "前进" : "后退");
    }
};

int main(int argc, char ** argv)
{
    rclcpp::init(argc, argv);
    auto node = std::make_shared<MoveController>();
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

**代码说明**：
1. 使用 **nlohmann/json** 库来生成 JSON 格式的参数
2. 每 100ms 发布一次运动指令（确保连续控制）
3. 每 2 秒切换一次方向

### 5.2 编译依赖配置

为了使用 `nlohmann/json` 库，需要修改 `package.xml` 和 `CMakeLists.txt`。

**package.xml** 添加依赖：
```xml
<depend>nlohmann-json-dev</depend>
```

**CMakeLists.txt** 添加：
```cmake
find_package(nlohmann_json REQUIRED)

target_link_libraries(move_controller nlohmann_json::nlohmann_json)
```

如果系统没有安装该库：
```bash
sudo apt install nlohmann-json3-dev
```

---

## 六、低层电机控制（高级用户）

### 6.1 注意事项

⚠️ **警告**：直接控制电机非常危险！
- 必须先关闭 APP 的主运控模式 `sport_mode`
- 必须将机器狗**架空**（防止摔倒损坏）
- 新手不建议使用低层控制

### 6.2 低层控制接口

```bash
# 查看话题类型
ros2 topic type /lowcmd
```

输出：
```
unitree_go/msg/LowCmd
```

### 6.3 查看消息结构

```bash
# 查看 LowCmd 消息定义
ros2 interface show unitree_go/msg/LowCmd
```

### 6.4 运行内置示例

```bash
# 进入 example 目录
cd ~/unitree_ros2/example

# 运行低层控制示例（请先架空机器狗！）
./install/unitree_ros2_example/bin/low_level_ctrl
```

---

## 七、运动控制内置示例

### 7.1 运行运动控制示例

```bash
# 进入 example 目录
cd ~/unitree_ros2/example

# 运行运动控制示例
./install/unitree_ros2_example/bin/sport_mode_ctrl
```

**程序功能**：
- Go2 会沿 X 轴来回走动
- 同时打印位置和速度信息

### 7.2 分析示例代码

示例代码位于：
```
~/unitree_ros2/example/src/sport_mode_ctrl.cpp
```

建议仔细阅读，学习如何：
- 发布运动控制指令
- 订阅状态反馈
- 实现闭环控制

---

## 八、常见问题解决

### 问题 1：发送指令后 Go2 没有反应

**可能原因**：
1. Go2 处于安全模式（APP 控制）
2. 环境变量没有正确设置
3. 网络连接问题

**解决方法**：
1. 确保 APP 允许外部控制
2. 重新加载环境：`source ~/unitree_ros2/setup.sh`
3. 检查网络：`ping 192.168.123.161`

### 问题 2：Go2 动作不稳定

**原因**：发布频率太低。

**解决**：确保以 **10 Hz 以上**的频率持续发布指令。

### 问题 3：参数格式错误

**常见错误**：
```json
// 错误（使用单引号）
{"x":0.1,'y':0.0}

// 正确（使用双引号）
{"x":0.1,"y":0.0}
```

---

## 九、小结

本节内容我们学习了：
✅ Go2 的控制架构（高层 vs 低层）
✅ 运动控制 API ID 的含义和用法
✅ 使用 rqt 进行可视化测试
✅ 编写运动控制程序
✅ 理解请求-响应式控制流程

**关键要点**：
- 优先使用高层运动控制（安全、简单）
- 需要持续发布指令（推荐 10 Hz）
- 动作完成后会自动恢复平衡站立
- 参数使用 JSON 格式字符串

**下一步**：我们将学习如何开发更复杂的功能包，包括键盘控制、Twist 桥接和可视化等。

---

## 拓展阅读

- [ROS2 发布者详解](https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Writing-A-Simple-Cpp-Publisher-And-Subscriber.html)
- [nlohmann/json 库文档](https://github.com/nlohmann/json)
- [机器人运动控制基础](https://en.wikipedia.org/wiki/Motion_control)
