# 3.1 键盘控制节点开发

## 学习目标
- 掌握 Python 多线程编程在 ROS2 中的应用
- 学会使用 termios 库读取键盘输入
- 实现完整的键盘控制 Go2 机器狗程序
- 理解按键映射和速度控制逻辑

---

## 一、功能简介

### 1.1 需求描述

开发一个键盘控制节点，通过键盘实时控制 Go2 机器狗的运动和动作：
- **方向控制**：WASD 键控制前后左右移动
- **动作触发**：特定按键触发打招呼、跳跃、舞蹈等动作
- **速度调节**：实时调整线速度和角速度
- **安全退出**：Ctrl+C 安全停止程序

### 1.2 技术要点

- **非阻塞键盘读取**：使用 `termios` 和 `tty` 库
- **多线程处理**：主线程读取键盘，子线程处理 ROS2 消息
- **按键映射表**：通过字典实现按键到控制指令的映射

---

## 二、创建功能包

### 2.1 进入工作目录

```bash
cd ~/unitree_go2_ws/src/base
```

### 2.2 创建 Python 功能包

```bash
ros2 pkg create go2_teleop_ctrl_keyboard \
    --build-type ament_python \
    --dependencies rclpy unitree_api \
    --node-name go2_teleop_ctrl_keyboard
```

**参数说明**：
- `go2_teleop_ctrl_keyboard`：功能包名称
- `--build-type ament_python`：Python 包
- `--dependencies rclpy unitree_api`：依赖包

---

## 三、理解键盘读取原理

### 3.1 标准键盘输入的问题

普通的 `input()` 函数：
- **阻塞式**：必须按回车才能读取
- **不适合**：实时控制场景

### 3.2 非阻塞键盘读取方案

使用 `termios` + `tty` 实现：
1. **保存终端设置**：保存当前终端配置
2. **设置原始模式**：关闭回显和缓冲
3. **读取单个字符**：立即获取按键
4. **恢复终端设置**：确保终端正常

```python
import termios
import sys
import tty

def getkey(settings):
    # 设置为原始模式（无回显，立即读取）
    tty.setraw(sys.stdin.fileno())
    # 读取一个字符
    key = sys.stdin.read(1)
    # 恢复终端设置
    termios.tcsetattr(sys.stdin, termios.TCSADRAIN, settings)
    return key

# 使用示例
settings = termios.tcgetattr(sys.stdin)
key = getkey(settings)
print(f"你按下了: {key}")
```

---

## 四、程序架构设计

### 4.1 为什么需要多线程？

**问题**：
- 主线程：阻塞式读取键盘
- ROS2 `spin()`：也是阻塞式

**解决方案**：
- **主线程**：读取键盘，处理按键逻辑
- **子线程**：运行 `rclpy.spin()`，处理 ROS2 消息

```python
import threading

# 创建 ROS2 节点
teleopNode = TeleopNode()

# 子线程运行 spin
spinner = threading.Thread(target=rclpy.spin, args=(teleopNode,))
spinner.start()

# 主线程读取键盘
while True:
    key = getkey(settings)
    # 处理按键...
```

### 4.2 按键映射设计

使用**字典**将按键映射到控制指令：

```python
# 动作模式映射
sportModel = {
    'h': 1016,  # 打招呼
    'J': 1031,  # 前跳
    'k': 1017,  # 伸展
    'n': 1009,  # 坐下
    'm': 1010,  # 站起
    'y': 1022,  # 舞蹈1
    'u': 1023,  # 舞蹈2
}

# 运动控制映射 (x, y, z, 角速度)
moveBindings = {
    'w': (1, 0, 0, 0),    # 前进
    's': (-1, 0, 0, 0),   # 后退
    'a': (0, 0, 0, 1),    # 左转
    'd': (0, 0, 0, -1),   # 右转
    'q': (1, 0, 0, 1),    # 前进+左转
    'e': (1, 0, 0, -1),   # 前进+右转
    # ... 更多组合
}

# 速度调整映射
speedBindings = {
    'r': (1.1, 1.1),   # 增加全部速度 10%
    't': (0.9, 0.9),   # 减少全部速度 10%
    'f': (1.1, 1),     # 仅增加线速度
    'g': (0.9, 1),     # 仅减少线速度
    'v': (1, 1.1),     # 仅增加角速度
    'b': (1, 0.9),     # 仅减少角速度
}
```

---

## 五、完整程序实现

### 5.1 导入必要库

打开 `go2_teleop_ctrl_keyboard/go2_teleop_ctrl_keyboard/go2_teleop_ctrl_keyboard.py`：

```python
"""
键盘控制 Go2 机器狗

功能：
1. WASD 控制移动
2. 特定按键触发动作
3. 实时速度调整
4. Ctrl+C 安全退出
"""

import rclpy
from rclpy.node import Node
from unitree_api.msg import Request
import termios
import sys
import tty
import threading
import json
```

### 5.2 定义 API ID 常量

```python
# 定义 Go2 运动控制 API ID
ROBOT_SPORT_API_IDS = {
    "DAMP": 1001,           # 阻尼控制
    "BALANCESTAND": 1002,   # 平衡站立
    "STOPMOVE": 1003,       # 停止运动
    "STANDUP": 1004,        # 站立
    "STANDDOWN": 1005,      # 站立下降
    "RECOVERYSTAND": 1006,  # 恢复站立
    "EULER": 1007,          # 欧拉角控制
    "MOVE": 1008,           # 移动
    "SIT": 1009,            # 坐下
    "RISESIT": 1010,        # 从坐下恢复站立
    "SWITCHGAIT": 1011,     # 切换步态
    "HELLO": 1016,          # 打招呼
    "STRETCH": 1017,        # 伸展
    "DANCE1": 1022,         # 舞蹈1
    "DANCE2": 1023,         # 舞蹈2
    "FRONTJUMP": 1031,      # 前跳
}
```

### 5.3 定义按键映射

```python
# 动作按键映射
sportModel = {
    'h': ROBOT_SPORT_API_IDS["HELLO"],
    'J': ROBOT_SPORT_API_IDS["FRONTJUMP"],
    'k': ROBOT_SPORT_API_IDS["STRETCH"],
    'n': ROBOT_SPORT_API_IDS["SIT"],
    'm': ROBOT_SPORT_API_IDS["RISESIT"],
    'y': ROBOT_SPORT_API_IDS["DANCE1"],
    'u': ROBOT_SPORT_API_IDS["DANCE2"],
}

# 运动按键映射 (前后, 左右, 未使用, 旋转)
moveBindings = {
    'w': (1, 0, 0, 0),      # 前进
    'e': (1, 0, 0, -1),     # 前进+右转
    'a': (0, 0, 0, 1),      # 左转
    'd': (0, 0, 0, -1),     # 右转
    'q': (1, 0, 0, 1),      # 前进+左转
    's': (-1, 0, 0, 0),     # 后退
    'c': (-1, 0, 0, 1),     # 后退+左转
    'z': (-1, 0, 0, -1),    # 后退+右转
    # Shift 键组合（横向移动）
    'W': (1, 0, 0, 0),
    'A': (0, 1, 0, 0),      # 左平移
    'D': (0, -1, 0, 0),     # 右平移
    'Q': (1, 1, 0, 0),
    'E': (1, -1, 0, 0),
}

# 速度调整按键
speedBindings = {
    'r': (1.1, 1.1),   # 全部加速
    't': (0.9, 0.9),   # 全部减速
    'f': (1.1, 1),     # 线速度加速
    'g': (0.9, 1),     # 线速度减速
    'v': (1, 1.1),     # 角速度加速
    'b': (1, 0.9),     # 角速度减速
}
```

### 5.4 创建 ROS2 节点类

```python
class TeleopNode(Node):
    def __init__(self):
        super().__init__('teleop_ctrl_keyboard')

        # 创建发布者
        self.pub = self.create_publisher(Request, "/api/sport/request", 10)

        # 声明速度参数
        self.declare_parameter("speed", 0.2)      # 线速度 m/s
        self.declare_parameter("angular", 0.5)    # 角速度 rad/s

        # 获取参数值
        self.speed = self.get_parameter("speed").value
        self.angular = self.get_parameter("angular").value

        self.get_logger().info("键盘控制节点已启动")
        self.get_logger().info(f"初始速度 - 线速度: {self.speed} m/s, 角速度: {self.angular} rad/s")

    def publish(self, api_id, x=0.0, y=0.0, z=0.0):
        """发布控制指令"""
        req = Request()
        req.header.identity.api_id = api_id

        # 如果是移动指令，设置参数
        if api_id == ROBOT_SPORT_API_IDS["MOVE"]:
            js = {"x": x, "y": y, "z": z}
            req.parameter = json.dumps(js)

        self.pub.publish(req)
```

### 5.5 实现键盘读取函数

```python
def getkey(settings):
    """非阻塞读取单个按键"""
    tty.setraw(sys.stdin.fileno())
    key = sys.stdin.read(1)
    termios.tcsetattr(sys.stdin, termios.TCSADRAIN, settings)
    return key
```

### 5.6 实现主函数

```python
# 帮助信息
msg = """
==================================================
       Go2 键盘控制
==================================================
移动控制：
    q   w   e
    a   s   d
    z   x   c

横向移动（Shift + 方向键）：
    Q   W   E
    A   s   D
    Z   x   C

速度调整：
    r/t : 增加/减少 全部速度 10%
    f/g : 增加/减少 线速度 10%
    v/b : 增加/减少 角速度 10%

动作控制：
    h : 打招呼
    J : 前跳 (Shift+j)
    k : 伸展
    n : 坐下
    m : 站起

    y : 舞蹈1
    u : 舞蹈2

其他按键 : 停止运动
Ctrl+C  : 退出程序
==================================================
"""

def main():
    print(msg)

    # 保存终端设置
    settings = termios.tcgetattr(sys.stdin)

    # 初始化 ROS2
    rclpy.init()

    # 创建节点
    teleopNode = TeleopNode()

    # 在子线程中运行 spin
    spinner = threading.Thread(target=rclpy.spin, args=(teleopNode,))
    spinner.start()

    try:
        while True:
            # 读取按键
            key = getkey(settings)

            # 1. Ctrl+C 退出
            if key == '\x03':  # \x03 是 Ctrl+C 的 ASCII 码
                break

            # 2. 动作模式
            elif key in sportModel:
                teleopNode.publish(sportModel[key])
                teleopNode.get_logger().info(f"执行动作: {key}")

            # 3. 运动控制
            elif key in moveBindings:
                x_dir, y_dir, _, z_dir = moveBindings[key]
                x = x_dir * teleopNode.speed
                y = y_dir * teleopNode.speed
                z = z_dir * teleopNode.angular

                teleopNode.publish(
                    ROBOT_SPORT_API_IDS["MOVE"],
                    x=x, y=y, z=z
                )

            # 4. 速度调整
            elif key in speedBindings:
                speed_mult, angular_mult = speedBindings[key]
                teleopNode.speed *= speed_mult
                teleopNode.angular *= angular_mult
                print(f"当前速度 - 线速度: {teleopNode.speed:.3f} m/s, 角速度: {teleopNode.angular:.3f} rad/s")

            # 5. 其他按键：停止
            else:
                teleopNode.publish(ROBOT_SPORT_API_IDS["BALANCESTAND"])

    finally:
        # 清理资源
        teleopNode.get_logger().info("退出键盘控制")
        rclpy.shutdown()

if __name__ == '__main__':
    main()
```

---

## 六、编译和运行

### 6.1 编译功能包

```bash
cd ~/unitree_go2_ws
colcon build --packages-select go2_teleop_ctrl_keyboard
source install/setup.bash
```

### 6.2 运行节点

**终端1**（启动 Go2 环境）：
```bash
source ~/unitree_ros2/setup.sh
```

**终端2**（运行键盘控制）：
```bash
cd ~/unitree_go2_ws
source install/setup.bash
ros2 run go2_teleop_ctrl_keyboard go2_teleop_ctrl_keyboard
```

### 6.3 测试控制

1. 按 `w` → Go2 前进
2. 按 `s` → Go2 后退
3. 按 `a` → Go2 左转
4. 按 `h` → Go2 打招呼
5. 按 `Ctrl+C` → 退出程序

---

## 七、常见问题解决

### 问题 1：按键没有反应

**原因**：终端焦点不在运行程序的窗口。

**解决**：确保鼠标点击了运行程序的终端窗口。

### 问题 2：程序退出后终端显示异常

**原因**：终端设置没有恢复。

**解决**：
```bash
# 手动重置终端
reset
```

或在代码中确保 `finally` 块执行。

### 问题 3：Go2 不动

**检查清单**：
1. Go2 是否开机？
2. 网络是否连接？（`ping 192.168.123.161`）
3. 环境是否加载？（`source ~/unitree_ros2/setup.sh`）

---

## 八、代码优化建议（可选）

### 8.1 添加参数文件

创建 `config/teleop.yaml`：
```yaml
/**:
  ros__parameters:
    speed: 0.3
    angular: 0.6
```

在启动时加载：
```bash
ros2 run go2_teleop_ctrl_keyboard go2_teleop_ctrl_keyboard \
    --ros-args --params-file config/teleop.yaml
```

### 8.2 添加按键说明界面

可以使用 `curses` 库创建更友好的界面（高级内容）。

---

## 九、小结

本节我们学习了：
✅ 使用 `termios` 库实现非阻塞键盘读取
✅ 理解多线程在 ROS2 中的应用
✅ 设计按键映射表实现灵活控制
✅ 实现完整的键盘控制 Go2 程序

**关键技术点**：
- 非阻塞 I/O
- Python 多线程
- 字典映射
- 异常处理

**下一步**：我们将学习 Twist 消息桥接，实现标准 ROS2 速度控制接口。

---

## 拓展阅读

- [Python termios 文档](https://docs.python.org/3/library/termios.html)
- [Python threading 文档](https://docs.python.org/3/library/threading.html)
- [ROS2 teleop_twist_keyboard](https://github.com/ros2/teleop_twist_keyboard)
