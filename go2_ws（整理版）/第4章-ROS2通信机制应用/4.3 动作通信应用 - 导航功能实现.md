# 4.3 åŠ¨ä½œé€šä¿¡åº”ç”¨ - å¯¼èˆªåŠŸèƒ½å®ç°

## å­¦ä¹ ç›®æ ‡
- ç†è§£åŠ¨ä½œé€šä¿¡çš„ä¸‰é˜¶æ®µæ¨¡å¼
- æŒæ¡è‡ªå®šä¹‰ action æ¥å£
- å®ç°å¸¦è¿›åº¦åé¦ˆçš„å¯¼èˆªåŠŸèƒ½
- å­¦ä¼šå¤„ç†ä»»åŠ¡å–æ¶ˆè¯·æ±‚

---

## ä¸€ã€åŠ¨ä½œé€šä¿¡ç®€ä»‹

### 1.1 ä»€ä¹ˆæ˜¯åŠ¨ä½œé€šä¿¡ï¼Ÿ

**åŠ¨ä½œï¼ˆActionï¼‰** æ˜¯ ROS2 ç”¨äºå¤„ç†**é•¿æ—¶ä»»åŠ¡**çš„å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼š

```
å®¢æˆ·ç«¯                           æœåŠ¡ç«¯
â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€
å‘é€ç›®æ ‡  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    æ¥æ”¶ç›®æ ‡
         â†“                   â†“
æ¥æ”¶åé¦ˆ  â†â”€â”€â”€â”€â”€åé¦ˆ1â”€â”€â”€â”€â”€â”€â”€â”€â”€    æ‰§è¡Œä»»åŠ¡
         â†â”€â”€â”€â”€â”€åé¦ˆ2â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â†â”€â”€â”€â”€â”€åé¦ˆ3â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â†“                   â†“
æ¥æ”¶ç»“æœ  â†â”€â”€â”€â”€â”€æœ€ç»ˆç»“æœâ”€â”€â”€â”€â”€â”€â”€    ä»»åŠ¡å®Œæˆ

å–æ¶ˆè¯·æ±‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    ä¸­æ­¢ä»»åŠ¡
```

### 1.2 åŠ¨ä½œé€šä¿¡çš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†

| éƒ¨åˆ† | æ•°æ®æµå‘ | è¯´æ˜ |
|------|---------|------|
| **Goalï¼ˆç›®æ ‡ï¼‰** | å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ | ä»»åŠ¡ç›®æ ‡å‚æ•° |
| **Feedbackï¼ˆåé¦ˆï¼‰** | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | æŒç»­çš„è¿›åº¦åé¦ˆ |
| **Resultï¼ˆç»“æœï¼‰** | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | æœ€ç»ˆæ‰§è¡Œç»“æœ |

### 1.3 ä¸æœåŠ¡é€šä¿¡çš„åŒºåˆ«

| ç‰¹æ€§ | æœåŠ¡ï¼ˆServiceï¼‰ | åŠ¨ä½œï¼ˆActionï¼‰ |
|------|----------------|---------------|
| æ‰§è¡Œæ—¶é—´ | çŸ­æ—¶é—´ | é•¿æ—¶é—´ |
| è¿›åº¦åé¦ˆ | æ—  | æœ‰ï¼ˆæŒç»­åé¦ˆï¼‰ |
| å¯å–æ¶ˆæ€§ | ä¸å¯å–æ¶ˆ | å¯å–æ¶ˆ |
| é€‚ç”¨åœºæ™¯ | ç®€å•è¯·æ±‚ | å¯¼èˆªã€æŠ“å–ç­‰å¤æ‚ä»»åŠ¡ |

### 1.4 æ¡ˆä¾‹éœ€æ±‚

å¼€å‘å¯¼èˆªåŠŸèƒ½ï¼š
- **å®¢æˆ·ç«¯**ï¼šå‘é€ç›®æ ‡è·ç¦»ï¼ˆå¦‚"å‰è¿› 1 ç±³"ï¼‰
- **æœåŠ¡ç«¯**ï¼š
  - æ§åˆ¶ Go2 å‰è¿›
  - å‘¨æœŸåé¦ˆå‰©ä½™è·ç¦»
  - åˆ°è¾¾ç›®æ ‡åå“åº”æœ€ç»ˆä½ç½®
  - æ”¯æŒä¸­é€”å–æ¶ˆ

---

## äºŒã€è‡ªå®šä¹‰ Action æ¥å£

### 2.1 å®šä¹‰ Action æ¥å£

åœ¨ `go2_tutorial_inter/action/` åˆ›å»º `Nav.action`ï¼š

```
# ç›®æ ‡ï¼šå‰è¿›è·ç¦»ï¼ˆç±³ï¼‰
float32 goal
---
# ç»“æœï¼šåˆ°è¾¾åçš„ä½ç½®
geometry_msgs/Point point
---
# åé¦ˆï¼šå‰©ä½™è·ç¦»ï¼ˆç±³ï¼‰
float32 distance
```

**è¯´æ˜**ï¼š
- ç¬¬1ä¸ª `---` ä¸Šæ–¹æ˜¯**ç›®æ ‡**
- ä¸¤ä¸ª `---` ä¹‹é—´æ˜¯**ç»“æœ**
- ç¬¬2ä¸ª `---` ä¸‹æ–¹æ˜¯**åé¦ˆ**

### 2.2 é…ç½®æ¥å£åŒ…

**package.xml æ·»åŠ **ï¼š
```xml
<depend>action_msgs</depend>
```

**CMakeLists.txt ä¿®æ”¹**ï¼š
```cmake
rosidl_generate_interfaces(${PROJECT_NAME}
  "srv/Cruising.srv"
  "action/Nav.action"
  DEPENDENCIES "geometry_msgs"
)
```

### 2.3 ç¼–è¯‘æ¥å£

```bash
cd ~/unitree_go2_ws
colcon build --packages-select go2_tutorial_inter
source install/setup.bash

# éªŒè¯æ¥å£
ros2 interface show go2_tutorial_inter/action/Nav
```

---

## ä¸‰ã€Action æœåŠ¡ç«¯å®ç°

### 3.1 åŠŸèƒ½è®¾è®¡

æœåŠ¡ç«¯éœ€è¦ï¼š
1. æ¥æ”¶ç›®æ ‡è·ç¦»ï¼Œåˆ¤æ–­åˆæ³•æ€§
2. æ§åˆ¶ Go2 å‰è¿›
3. å‘¨æœŸæ€§è®¡ç®—å¹¶åé¦ˆå‰©ä½™è·ç¦»
4. åˆ°è¾¾ç›®æ ‡æˆ–è¢«å–æ¶ˆæ—¶åœæ­¢
5. å“åº”æœ€ç»ˆä½ç½®

### 3.2 C++ æœåŠ¡ç«¯

**package.xml æ·»åŠ **ï¼š
```xml
<depend>rclcpp_action</depend>
```

**CMakeLists.txt æ·»åŠ **ï¼š
```cmake
find_package(rclcpp_action REQUIRED)

add_executable(go2_nav_server src/go2_nav_server.cpp)
ament_target_dependencies(go2_nav_server
  "rclcpp"
  "rclcpp_action"
  "unitree_go"
  "unitree_api"
  "nav_msgs"
  "geometry_msgs"
  "go2_tutorial_inter"
)

install(TARGETS go2_nav_server
  DESTINATION lib/${PROJECT_NAME})
```

**src/go2_nav_server.cpp**ï¼š

```cpp
/*
åŠŸèƒ½ï¼šå¯¼èˆª Action æœåŠ¡ç«¯
- æ¥æ”¶ç›®æ ‡è·ç¦»
- åé¦ˆå‰©ä½™è·ç¦»
- å“åº”æœ€ç»ˆä½ç½®
*/

#include "rclcpp/rclcpp.hpp"
#include "rclcpp_action/rclcpp_action.hpp"
#include "go2_tutorial_inter/action/nav.hpp"
#include "nav_msgs/msg/odometry.hpp"
#include "geometry_msgs/msg/point.hpp"
#include "sport_model.hpp"

using namespace rclcpp_action;
using namespace std::placeholders;
using namespace std::chrono_literals;

class NavServer : public rclcpp::Node
{
public:
    using Nav = go2_tutorial_inter::action::Nav;
    using GoalHandle = ServerGoalHandle<Nav>;

    NavServer() : Node("go2_nav_server")
    {
        RCLCPP_INFO(this->get_logger(), "å¯¼èˆªæœåŠ¡ç«¯å¯åŠ¨");

        // å£°æ˜å‚æ•°
        this->declare_parameter("x", 0.3);     // å‰è¿›é€Ÿåº¦
        this->declare_parameter("error", 0.2); // è¯¯å·®èŒƒå›´

        // è¿œç¨‹å‚æ•°å®¢æˆ·ç«¯
        param_client_ = std::make_shared<rclcpp::AsyncParametersClient>(
            this, "go2_ctrl");

        // ç­‰å¾…å‚æ•°æœåŠ¡
        while (!param_client_->wait_for_service(1s))
        {
            if (!rclcpp::ok()) return;
            RCLCPP_INFO(this->get_logger(), "ç­‰å¾… go2_ctrl...");
        }

        // è®¢é˜…é‡Œç¨‹è®¡
        odom_sub_ = this->create_subscription<nav_msgs::msg::Odometry>(
            "odom", 10, std::bind(&NavServer::odom_cb, this, _1));

        // åˆ›å»º Action æœåŠ¡å™¨
        action_server_ = create_server<Nav>(
            this, "nav",
            std::bind(&NavServer::handle_goal, this, _1, _2),
            std::bind(&NavServer::handle_cancel, this, _1),
            std::bind(&NavServer::handle_accepted, this, _1));
    }

private:
    rclcpp::AsyncParametersClient::SharedPtr param_client_;
    rclcpp::Subscription<nav_msgs::msg::Odometry>::SharedPtr odom_sub_;
    Server<Nav>::SharedPtr action_server_;
    geometry_msgs::msg::Point current_point_, start_point_;

    void odom_cb(const nav_msgs::msg::Odometry::SharedPtr msg)
    {
        current_point_ = msg->pose.pose.position;
    }

    // 1. å¤„ç†ç›®æ ‡è¯·æ±‚
    GoalResponse handle_goal(
        const GoalUUID & uuid, std::shared_ptr<const Nav::Goal> goal)
    {
        (void)uuid;

        if (goal->goal > 0.0)
        {
            RCLCPP_INFO(this->get_logger(), "æ¥å—ç›®æ ‡: å‰è¿› %.2f ç±³", goal->goal);
            start_point_ = current_point_;

            // å¯åŠ¨ç§»åŠ¨
            param_client_->set_parameters({
                rclcpp::Parameter("sport_api_id", ROBOT_SPORT_API_ID_MOVE),
                this->get_parameter("x")
            });

            return GoalResponse::ACCEPT_AND_EXECUTE;
        }
        else
        {
            RCLCPP_ERROR(this->get_logger(), "ç›®æ ‡è·ç¦»æ— æ•ˆ: %.2f", goal->goal);
            return GoalResponse::REJECT;
        }
    }

    // 2. å¤„ç†å–æ¶ˆè¯·æ±‚
    CancelResponse handle_cancel(const std::shared_ptr<GoalHandle> goal_handle)
    {
        (void)goal_handle;
        RCLCPP_INFO(this->get_logger(), "æ¥æ”¶åˆ°å–æ¶ˆè¯·æ±‚");
        stop_move();
        return CancelResponse::ACCEPT;
    }

    // 3. æ‰§è¡Œä»»åŠ¡
    void handle_accepted(const std::shared_ptr<GoalHandle> goal_handle)
    {
        // åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡
        std::thread{std::bind(&NavServer::execute, this, _1), goal_handle}.detach();
    }

    void execute(const std::shared_ptr<GoalHandle> goal_handle)
    {
        auto feedback = std::make_shared<Nav::Feedback>();
        auto result = std::make_shared<Nav::Result>();

        rclcpp::Rate rate(1.0);  // 1 Hz åé¦ˆ

        while (rclcpp::ok())
        {
            // è®¡ç®—å·²è¡Œè¿›è·ç¦»
            double dx = current_point_.x - start_point_.x;
            double dy = current_point_.y - start_point_.y;
            double traveled = std::sqrt(dx*dx + dy*dy);

            // è®¡ç®—å‰©ä½™è·ç¦»
            double remaining = goal_handle->get_goal()->goal - traveled;
            feedback->distance = remaining;

            // å‘å¸ƒåé¦ˆ
            goal_handle->publish_feedback(feedback);
            RCLCPP_INFO(this->get_logger(), "å‰©ä½™è·ç¦»: %.2f ç±³", remaining);

            // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
            if (goal_handle->is_canceling())
            {
                stop_move();
                result->point = current_point_;
                goal_handle->canceled(result);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾
            if (remaining <= this->get_parameter("error").as_double())
            {
                RCLCPP_INFO(this->get_logger(), "å·²åˆ°è¾¾ç›®æ ‡");
                stop_move();
                break;
            }

            rate.sleep();
        }

        // å“åº”æˆåŠŸ
        if (rclcpp::ok())
        {
            result->point = current_point_;
            goal_handle->succeed(result);
        }
    }

    void stop_move()
    {
        param_client_->set_parameters({
            rclcpp::Parameter("sport_api_id", ROBOT_SPORT_API_ID_STOPMOVE),
            rclcpp::Parameter("x", 0.0),
            rclcpp::Parameter("y", 0.0),
            rclcpp::Parameter("z", 0.0),
        });
    }
};

int main(int argc, char ** argv)
{
    rclcpp::init(argc, argv);
    rclcpp::spin(std::make_shared<NavServer>());
    rclcpp::shutdown();
    return 0;
}
```

---

## å››ã€Action å®¢æˆ·ç«¯å®ç°

**src/go2_nav_client.cpp**ï¼š

```cpp
/*
åŠŸèƒ½ï¼šå¯¼èˆª Action å®¢æˆ·ç«¯
*/

#include "rclcpp/rclcpp.hpp"
#include "rclcpp_action/rclcpp_action.hpp"
#include "go2_tutorial_inter/action/nav.hpp"

using namespace std::placeholders;
using namespace std::chrono_literals;

class NavClient : public rclcpp::Node
{
public:
    using Nav = go2_tutorial_inter::action::Nav;

    NavClient(const rclcpp::NodeOptions & options = rclcpp::NodeOptions())
        : Node("go2_nav_client", options)
    {
        client_ = rclcpp_action::create_client<Nav>(this, "nav");
    }

    bool connect_server()
    {
        while (!client_->wait_for_action_server(1s))
        {
            if (!rclcpp::ok()) return false;
            RCLCPP_INFO(this->get_logger(), "ç­‰å¾… Action æœåŠ¡å™¨...");
        }
        return true;
    }

    void send_goal(float distance)
    {
        Nav::Goal goal;
        goal.goal = distance;

        auto options = rclcpp_action::Client<Nav>::SendGoalOptions();
        options.goal_response_callback =
            std::bind(&NavClient::goal_response_cb, this, _1);
        options.feedback_callback =
            std::bind(&NavClient::feedback_cb, this, _1, _2);
        options.result_callback =
            std::bind(&NavClient::result_cb, this, _1);

        client_->async_send_goal(goal, options);
    }

private:
    rclcpp_action::Client<Nav>::SharedPtr client_;

    void goal_response_cb(std::shared_ptr<rclcpp_action::ClientGoalHandle<Nav>> goal_handle)
    {
        if (goal_handle)
        {
            RCLCPP_INFO(this->get_logger(), "ç›®æ ‡è¢«æ¥å—");
        }
        else
        {
            RCLCPP_ERROR(this->get_logger(), "ç›®æ ‡è¢«æ‹’ç»");
            rclcpp::shutdown();
        }
    }

    void feedback_cb(
        rclcpp_action::ClientGoalHandle<Nav>::SharedPtr,
        const std::shared_ptr<const Nav::Feedback> feedback)
    {
        RCLCPP_INFO(this->get_logger(),
            "åé¦ˆï¼šå‰©ä½™ %.2f ç±³", feedback->distance);
    }

    void result_cb(const rclcpp_action::ClientGoalHandle<Nav>::WrappedResult & result)
    {
        switch (result.code)
        {
        case rclcpp_action::ResultCode::SUCCEEDED:
            RCLCPP_INFO(this->get_logger(),
                "æˆåŠŸï¼æœ€ç»ˆä½ç½®: (%.2f, %.2f)",
                result.result->point.x, result.result->point.y);
            break;
        case rclcpp_action::ResultCode::CANCELED:
            RCLCPP_INFO(this->get_logger(), "ä»»åŠ¡è¢«å–æ¶ˆ");
            break;
        default:
            RCLCPP_ERROR(this->get_logger(), "æœªçŸ¥é”™è¯¯");
            break;
        }
        rclcpp::shutdown();
    }
};

int main(int argc, char ** argv)
{
    if (argc != 2)
    {
        std::cerr << "ç”¨æ³•: ros2 run go2_tutorial go2_nav_client <è·ç¦»>" << std::endl;
        return 1;
    }

    rclcpp::init(argc, argv);
    auto client = std::make_shared<NavClient>();

    if (!client->connect_server()) return 1;

    client->send_goal(std::atof(argv[1]));
    rclcpp::spin(client);
    rclcpp::shutdown();
    return 0;
}
```

---

## äº”ã€è¿è¡Œæµ‹è¯•

### 5.1 ç¼–è¯‘

```bash
cd ~/unitree_go2_ws
colcon build --packages-select go2_tutorial
source install/setup.bash
```

### 5.2 å¯åŠ¨æœåŠ¡ç«¯

```bash
source ~/unitree_ros2/setup.sh
ros2 run go2_tutorial go2_nav_server
```

### 5.3 å‘é€å¯¼èˆªç›®æ ‡

```bash
# å‰è¿› 1.5 ç±³
ros2 run go2_tutorial go2_nav_client 1.5
```

**è§‚å¯Ÿ**ï¼š
- ç»ˆç«¯ä¼šæ˜¾ç¤ºå‰©ä½™è·ç¦»åé¦ˆ
- Go2 ä¼šå‰è¿›çº¦ 1.5 ç±³ååœæ­¢

### 5.4 ä½¿ç”¨ ros2 action å‘½ä»¤

```bash
# æŸ¥çœ‹ Action åˆ—è¡¨
ros2 action list

# å‘é€ç›®æ ‡ï¼ˆå¸¦åé¦ˆæ˜¾ç¤ºï¼‰
ros2 action send_goal /nav go2_tutorial_inter/action/Nav "{goal: 1.0}" -f
```

---

## å…­ã€å°ç»“

æœ¬èŠ‚å­¦ä¹ äº†ï¼š
âœ… åŠ¨ä½œé€šä¿¡çš„ä¸‰é˜¶æ®µæ¨¡å¼ï¼ˆç›®æ ‡-åé¦ˆ-ç»“æœï¼‰
âœ… è‡ªå®šä¹‰ action æ¥å£
âœ… Action æœåŠ¡ç«¯çš„å¤šå›è°ƒå¤„ç†
âœ… Action å®¢æˆ·ç«¯çš„å¼‚æ­¥è°ƒç”¨
âœ… ä»»åŠ¡å–æ¶ˆæœºåˆ¶

**å…³é”®æ¦‚å¿µ**ï¼š
- **Goal**ï¼šä»»åŠ¡ç›®æ ‡
- **Feedback**ï¼šæŒç»­è¿›åº¦åé¦ˆ
- **Result**ï¼šæœ€ç»ˆç»“æœ
- **å¼‚æ­¥æ‰§è¡Œ**ï¼šä½¿ç”¨çº¿ç¨‹é¿å…é˜»å¡

---

## ğŸ“ ç¬¬å››ç« æ€»ç»“

### ä¸‰ç§é€šä¿¡æœºåˆ¶å¯¹æ¯”

| é€šä¿¡æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | æ¡ˆä¾‹ |
|---------|------|---------|------|
| **è¯é¢˜** | å‘å¸ƒ-è®¢é˜…ï¼ŒæŒç»­æ•°æ®æµ | ä¼ æ„Ÿå™¨æ•°æ®ã€çŠ¶æ€ç›‘æ§ | é€Ÿåº¦æ§åˆ¶ã€ä½ç½®è·å– |
| **æœåŠ¡** | è¯·æ±‚-å“åº”ï¼ŒåŒæ­¥ | å¶å‘æ€§æ“ä½œ | å¯åœæ§åˆ¶ |
| **åŠ¨ä½œ** | é•¿æ—¶ä»»åŠ¡ï¼Œå¸¦åé¦ˆ | å¯¼èˆªã€æŠ“å–ç­‰å¤æ‚ä»»åŠ¡ | å‰è¿›Nç±³ |

### å­¦ä¹ æˆæœ

âœ… æŒæ¡äº† ROS2 ä¸‰ç§æ ¸å¿ƒé€šä¿¡æœºåˆ¶
âœ… å­¦ä¼šäº†è‡ªå®šä¹‰æ¥å£ï¼ˆsrv, actionï¼‰
âœ… å®ç°äº†å®Œæ•´çš„ Go2 æ§åˆ¶åº”ç”¨
âœ… ç†è§£äº†å‚æ•°æœåŠ¡å’Œè¿œç¨‹è®¿é—®

**æ­å–œä½ å®Œæˆäº†å…¨éƒ¨å››ç« çš„å­¦ä¹ ï¼** ğŸ‰

---

## æ‹“å±•é˜…è¯»

- [ROS2 Action è¯¦è§£](https://docs.ros.org/en/humble/Tutorials/Intermediate/Writing-an-Action-Server-Client/Cpp.html)
- [è‡ªå®šä¹‰ Action æ¥å£](https://docs.ros.org/en/humble/Tutorials/Intermediate/Creating-an-Action.html)
